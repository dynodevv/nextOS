/*
 * nextOS - framebuffer.c
 * Double-buffered framebuffer with drawing primitives and BGA mode switching
 */
#include "framebuffer.h"
#include "../mem/heap.h"
#include "../arch/x86_64/idt.h"

/* ── Bochs Graphics Adapter (BGA) registers for runtime mode switching ── */
#define VBE_DISPI_IOPORT_INDEX  0x01CE
#define VBE_DISPI_IOPORT_DATA   0x01CF

#define VBE_DISPI_INDEX_ID      0x00
#define VBE_DISPI_INDEX_XRES    0x01
#define VBE_DISPI_INDEX_YRES    0x02
#define VBE_DISPI_INDEX_BPP     0x03
#define VBE_DISPI_INDEX_ENABLE  0x04
#define VBE_DISPI_INDEX_BANK    0x05
#define VBE_DISPI_INDEX_VIRT_W  0x06
#define VBE_DISPI_INDEX_VIRT_H  0x07
#define VBE_DISPI_INDEX_X_OFF   0x08
#define VBE_DISPI_INDEX_Y_OFF   0x09

#define VBE_DISPI_DISABLED      0x00
#define VBE_DISPI_ENABLED       0x01
#define VBE_DISPI_LFB_ENABLED   0x40

static framebuffer_t fb;
static int bga_detected = 0;  /* Cached BGA availability (probed once at init) */

static void bga_write(uint16_t reg, uint16_t val)
{
    outw(VBE_DISPI_IOPORT_INDEX, reg);
    outw(VBE_DISPI_IOPORT_DATA, val);
}

static uint16_t bga_read(uint16_t reg)
{
    outw(VBE_DISPI_IOPORT_INDEX, reg);
    return inw(VBE_DISPI_IOPORT_DATA);
}

static void bga_probe(void)
{
    uint16_t id = bga_read(VBE_DISPI_INDEX_ID);
    bga_detected = (id >= 0xB0C0 && id <= 0xB0CF);
}

/* ── Built-in 8x16 bitmap font (ASCII 32-126) ────────────────────────── */
/* Minimal bitmapped font — each character is 8 pixels wide, 16 rows tall.
 * Stored as 16 bytes per glyph (one byte per row, MSB = leftmost pixel).
 * Only printable ASCII subset is defined here. */
const uint8_t font_8x16[95][16] = {
    /* ' ' (space) */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
     0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* '!' */
    {0x00,0x00,0x18,0x3C,0x3C,0x3C,0x18,0x18,
     0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    /* '"' */
    {0x00,0x66,0x66,0x66,0x24,0x00,0x00,0x00,
     0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* '#' */
    {0x00,0x00,0x00,0x6C,0x6C,0xFE,0x6C,0x6C,
     0x6C,0xFE,0x6C,0x6C,0x00,0x00,0x00,0x00},
    /* '$' */
    {0x18,0x18,0x7C,0xC6,0xC2,0xC0,0x7C,0x06,
     0x06,0x86,0xC6,0x7C,0x18,0x18,0x00,0x00},
    /* '%' */
    {0x00,0x00,0x00,0x00,0xC2,0xC6,0x0C,0x18,
     0x30,0x60,0xC6,0x86,0x00,0x00,0x00,0x00},
    /* '&' */
    {0x00,0x00,0x38,0x6C,0x6C,0x38,0x76,0xDC,
     0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    /* '\'' */
    {0x00,0x30,0x30,0x30,0x60,0x00,0x00,0x00,
     0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* '(' */
    {0x00,0x00,0x0C,0x18,0x30,0x30,0x30,0x30,
     0x30,0x30,0x18,0x0C,0x00,0x00,0x00,0x00},
    /* ')' */
    {0x00,0x00,0x30,0x18,0x0C,0x0C,0x0C,0x0C,
     0x0C,0x0C,0x18,0x30,0x00,0x00,0x00,0x00},
    /* '*' */
    {0x00,0x00,0x00,0x00,0x00,0x66,0x3C,0xFF,
     0x3C,0x66,0x00,0x00,0x00,0x00,0x00,0x00},
    /* '+' */
    {0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x7E,
     0x18,0x18,0x00,0x00,0x00,0x00,0x00,0x00},
    /* ',' */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
     0x00,0x18,0x18,0x18,0x30,0x00,0x00,0x00},
    /* '-' */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFE,
     0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* '.' */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
     0x00,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    /* '/' */
    {0x00,0x00,0x00,0x00,0x02,0x06,0x0C,0x18,
     0x30,0x60,0xC0,0x80,0x00,0x00,0x00,0x00},
    /* '0' */
    {0x00,0x00,0x7C,0xC6,0xC6,0xCE,0xDE,0xF6,
     0xE6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* '1' */
    {0x00,0x00,0x18,0x38,0x78,0x18,0x18,0x18,
     0x18,0x18,0x18,0x7E,0x00,0x00,0x00,0x00},
    /* '2' */
    {0x00,0x00,0x7C,0xC6,0x06,0x0C,0x18,0x30,
     0x60,0xC0,0xC6,0xFE,0x00,0x00,0x00,0x00},
    /* '3' */
    {0x00,0x00,0x7C,0xC6,0x06,0x06,0x3C,0x06,
     0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* '4' */
    {0x00,0x00,0x0C,0x1C,0x3C,0x6C,0xCC,0xFE,
     0x0C,0x0C,0x0C,0x1E,0x00,0x00,0x00,0x00},
    /* '5' */
    {0x00,0x00,0xFE,0xC0,0xC0,0xC0,0xFC,0x06,
     0x06,0x06,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* '6' */
    {0x00,0x00,0x38,0x60,0xC0,0xC0,0xFC,0xC6,
     0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* '7' */
    {0x00,0x00,0xFE,0xC6,0x06,0x06,0x0C,0x18,
     0x30,0x30,0x30,0x30,0x00,0x00,0x00,0x00},
    /* '8' */
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7C,0xC6,
     0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* '9' */
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0x7E,0x06,
     0x06,0x06,0x0C,0x78,0x00,0x00,0x00,0x00},
    /* ':' */
    {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,
     0x00,0x18,0x18,0x00,0x00,0x00,0x00,0x00},
    /* ';' */
    {0x00,0x00,0x00,0x00,0x18,0x18,0x00,0x00,
     0x00,0x18,0x18,0x30,0x00,0x00,0x00,0x00},
    /* '<' */
    {0x00,0x00,0x00,0x06,0x0C,0x18,0x30,0x60,
     0x30,0x18,0x0C,0x06,0x00,0x00,0x00,0x00},
    /* '=' */
    {0x00,0x00,0x00,0x00,0x00,0x7E,0x00,0x00,
     0x7E,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* '>' */
    {0x00,0x00,0x00,0x60,0x30,0x18,0x0C,0x06,
     0x0C,0x18,0x30,0x60,0x00,0x00,0x00,0x00},
    /* '?' */
    {0x00,0x00,0x7C,0xC6,0xC6,0x0C,0x18,0x18,
     0x18,0x00,0x18,0x18,0x00,0x00,0x00,0x00},
    /* '@' */
    {0x00,0x00,0x00,0x7C,0xC6,0xC6,0xDE,0xDE,
     0xDE,0xDC,0xC0,0x7C,0x00,0x00,0x00,0x00},
    /* 'A' */
    {0x00,0x00,0x10,0x38,0x6C,0xC6,0xC6,0xFE,
     0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    /* 'B' */
    {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x66,
     0x66,0x66,0x66,0xFC,0x00,0x00,0x00,0x00},
    /* 'C' */
    {0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xC0,
     0xC0,0xC2,0x66,0x3C,0x00,0x00,0x00,0x00},
    /* 'D' */
    {0x00,0x00,0xF8,0x6C,0x66,0x66,0x66,0x66,
     0x66,0x66,0x6C,0xF8,0x00,0x00,0x00,0x00},
    /* 'E' */
    {0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,
     0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00},
    /* 'F' */
    {0x00,0x00,0xFE,0x66,0x62,0x68,0x78,0x68,
     0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    /* 'G' */
    {0x00,0x00,0x3C,0x66,0xC2,0xC0,0xC0,0xDE,
     0xC6,0xC6,0x66,0x3A,0x00,0x00,0x00,0x00},
    /* 'H' */
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xFE,0xC6,
     0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    /* 'I' */
    {0x00,0x00,0x3C,0x18,0x18,0x18,0x18,0x18,
     0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* 'J' */
    {0x00,0x00,0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,
     0xCC,0xCC,0xCC,0x78,0x00,0x00,0x00,0x00},
    /* 'K' */
    {0x00,0x00,0xE6,0x66,0x66,0x6C,0x78,0x78,
     0x6C,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    /* 'L' */
    {0x00,0x00,0xF0,0x60,0x60,0x60,0x60,0x60,
     0x60,0x62,0x66,0xFE,0x00,0x00,0x00,0x00},
    /* 'M' */
    {0x00,0x00,0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,
     0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    /* 'N' */
    {0x00,0x00,0xC6,0xE6,0xF6,0xFE,0xDE,0xCE,
     0xC6,0xC6,0xC6,0xC6,0x00,0x00,0x00,0x00},
    /* 'O' */
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,
     0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 'P' */
    {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x60,
     0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    /* 'Q' */
    {0x00,0x00,0x7C,0xC6,0xC6,0xC6,0xC6,0xC6,
     0xC6,0xD6,0xDE,0x7C,0x0C,0x0E,0x00,0x00},
    /* 'R' */
    {0x00,0x00,0xFC,0x66,0x66,0x66,0x7C,0x6C,
     0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    /* 'S' */
    {0x00,0x00,0x7C,0xC6,0xC6,0x60,0x38,0x0C,
     0x06,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 'T' */
    {0x00,0x00,0xFF,0xDB,0x99,0x18,0x18,0x18,
     0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* 'U' */
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,
     0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 'V' */
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xC6,0xC6,
     0xC6,0x6C,0x38,0x10,0x00,0x00,0x00,0x00},
    /* 'W' */
    {0x00,0x00,0xC6,0xC6,0xC6,0xC6,0xD6,0xD6,
     0xD6,0xFE,0xEE,0x6C,0x00,0x00,0x00,0x00},
    /* 'X' */
    {0x00,0x00,0xC6,0xC6,0x6C,0x7C,0x38,0x38,
     0x7C,0x6C,0xC6,0xC6,0x00,0x00,0x00,0x00},
    /* 'Y' */
    {0x00,0x00,0xC6,0xC6,0xC6,0x6C,0x38,0x18,
     0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* 'Z' */
    {0x00,0x00,0xFE,0xC6,0x86,0x0C,0x18,0x30,
     0x60,0xC2,0xC6,0xFE,0x00,0x00,0x00,0x00},
    /* '[' */
    {0x00,0x00,0x3C,0x30,0x30,0x30,0x30,0x30,
     0x30,0x30,0x30,0x3C,0x00,0x00,0x00,0x00},
    /* '\\' */
    {0x00,0x00,0x00,0x80,0xC0,0xE0,0x70,0x38,
     0x1C,0x0E,0x06,0x02,0x00,0x00,0x00,0x00},
    /* ']' */
    {0x00,0x00,0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,
     0x0C,0x0C,0x0C,0x3C,0x00,0x00,0x00,0x00},
    /* '^' */
    {0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00,
     0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* '_' */
    {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
     0x00,0x00,0x00,0x00,0xFF,0x00,0x00,0x00},
    /* '`' */
    {0x30,0x30,0x18,0x00,0x00,0x00,0x00,0x00,
     0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* 'a' */
    {0x00,0x00,0x00,0x00,0x00,0x78,0x0C,0x7C,
     0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    /* 'b' */
    {0x00,0x00,0xE0,0x60,0x60,0x78,0x6C,0x66,
     0x66,0x66,0x66,0x7C,0x00,0x00,0x00,0x00},
    /* 'c' */
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC0,
     0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 'd' */
    {0x00,0x00,0x1C,0x0C,0x0C,0x3C,0x6C,0xCC,
     0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    /* 'e' */
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xFE,
     0xC0,0xC0,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 'f' */
    {0x00,0x00,0x1C,0x36,0x32,0x30,0x78,0x30,
     0x30,0x30,0x30,0x78,0x00,0x00,0x00,0x00},
    /* 'g' */
    {0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,
     0xCC,0xCC,0x7C,0x0C,0xCC,0x78,0x00,0x00},
    /* 'h' */
    {0x00,0x00,0xE0,0x60,0x60,0x6C,0x76,0x66,
     0x66,0x66,0x66,0xE6,0x00,0x00,0x00,0x00},
    /* 'i' */
    {0x00,0x00,0x18,0x18,0x00,0x38,0x18,0x18,
     0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* 'j' */
    {0x00,0x00,0x06,0x06,0x00,0x0E,0x06,0x06,
     0x06,0x06,0x06,0x06,0x66,0x3C,0x00,0x00},
    /* 'k' */
    {0x00,0x00,0xE0,0x60,0x60,0x66,0x6C,0x78,
     0x78,0x6C,0x66,0xE6,0x00,0x00,0x00,0x00},
    /* 'l' */
    {0x00,0x00,0x38,0x18,0x18,0x18,0x18,0x18,
     0x18,0x18,0x18,0x3C,0x00,0x00,0x00,0x00},
    /* 'm' */
    {0x00,0x00,0x00,0x00,0x00,0xEC,0xFE,0xD6,
     0xD6,0xD6,0xD6,0xC6,0x00,0x00,0x00,0x00},
    /* 'n' */
    {0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,
     0x66,0x66,0x66,0x66,0x00,0x00,0x00,0x00},
    /* 'o' */
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0xC6,
     0xC6,0xC6,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 'p' */
    {0x00,0x00,0x00,0x00,0x00,0xDC,0x66,0x66,
     0x66,0x66,0x7C,0x60,0x60,0xF0,0x00,0x00},
    /* 'q' */
    {0x00,0x00,0x00,0x00,0x00,0x76,0xCC,0xCC,
     0xCC,0xCC,0x7C,0x0C,0x0C,0x1E,0x00,0x00},
    /* 'r' */
    {0x00,0x00,0x00,0x00,0x00,0xDC,0x76,0x66,
     0x60,0x60,0x60,0xF0,0x00,0x00,0x00,0x00},
    /* 's' */
    {0x00,0x00,0x00,0x00,0x00,0x7C,0xC6,0x60,
     0x38,0x0C,0xC6,0x7C,0x00,0x00,0x00,0x00},
    /* 't' */
    {0x00,0x00,0x10,0x30,0x30,0xFC,0x30,0x30,
     0x30,0x30,0x36,0x1C,0x00,0x00,0x00,0x00},
    /* 'u' */
    {0x00,0x00,0x00,0x00,0x00,0xCC,0xCC,0xCC,
     0xCC,0xCC,0xCC,0x76,0x00,0x00,0x00,0x00},
    /* 'v' */
    {0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xC6,
     0xC6,0x6C,0x38,0x10,0x00,0x00,0x00,0x00},
    /* 'w' */
    {0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xD6,
     0xD6,0xD6,0xFE,0x6C,0x00,0x00,0x00,0x00},
    /* 'x' */
    {0x00,0x00,0x00,0x00,0x00,0xC6,0x6C,0x38,
     0x38,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00},
    /* 'y' */
    {0x00,0x00,0x00,0x00,0x00,0xC6,0xC6,0xC6,
     0xC6,0xC6,0x7E,0x06,0x0C,0xF8,0x00,0x00},
    /* 'z' */
    {0x00,0x00,0x00,0x00,0x00,0xFE,0xCC,0x18,
     0x30,0x60,0xC6,0xFE,0x00,0x00,0x00,0x00},
    /* '{' */
    {0x00,0x00,0x0E,0x18,0x18,0x18,0x70,0x18,
     0x18,0x18,0x18,0x0E,0x00,0x00,0x00,0x00},
    /* '|' */
    {0x00,0x00,0x18,0x18,0x18,0x18,0x00,0x18,
     0x18,0x18,0x18,0x18,0x00,0x00,0x00,0x00},
    /* '}' */
    {0x00,0x00,0x70,0x18,0x18,0x18,0x0E,0x18,
     0x18,0x18,0x18,0x70,0x00,0x00,0x00,0x00},
    /* '~' */
    {0x00,0x00,0x76,0xDC,0x00,0x00,0x00,0x00,
     0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
};

void fb_init(uint64_t addr, uint32_t w, uint32_t h, uint32_t pitch, uint32_t bpp)
{
    fb.address = (uint32_t *)addr;
    fb.width   = w;
    fb.height  = h;
    fb.pitch   = pitch;
    fb.bpp     = bpp;

    /* Probe BGA once for runtime resolution switching */
    bga_probe();

    /* Allocate back buffer */
    fb.backbuffer = (uint32_t *)kmalloc(w * h * 4);
    if (!fb.backbuffer) {
        fb.backbuffer = fb.address; /* fallback: single buffer */
    }
}

int fb_set_resolution(uint32_t w, uint32_t h)
{
    if (!bga_detected) return -1;
    if (w == fb.width && h == fb.height) return 0;

    /* Program BGA for new mode */
    bga_write(VBE_DISPI_INDEX_ENABLE, VBE_DISPI_DISABLED);
    bga_write(VBE_DISPI_INDEX_XRES, (uint16_t)w);
    bga_write(VBE_DISPI_INDEX_YRES, (uint16_t)h);
    bga_write(VBE_DISPI_INDEX_BPP, 32);
    bga_write(VBE_DISPI_INDEX_VIRT_W, (uint16_t)w);
    bga_write(VBE_DISPI_INDEX_VIRT_H, (uint16_t)h);
    bga_write(VBE_DISPI_INDEX_X_OFF, 0);
    bga_write(VBE_DISPI_INDEX_Y_OFF, 0);
    bga_write(VBE_DISPI_INDEX_ENABLE, VBE_DISPI_ENABLED | VBE_DISPI_LFB_ENABLED);

    /* Verify mode was accepted */
    uint16_t actual_w = bga_read(VBE_DISPI_INDEX_XRES);
    uint16_t actual_h = bga_read(VBE_DISPI_INDEX_YRES);
    if (actual_w != (uint16_t)w || actual_h != (uint16_t)h) return -1;

    /* Free old backbuffer if it was heap-allocated */
    if (fb.backbuffer && fb.backbuffer != fb.address)
        kfree(fb.backbuffer);

    fb.width  = w;
    fb.height = h;
    fb.pitch  = w * 4;
    fb.bpp    = 32;

    /* Allocate new backbuffer */
    fb.backbuffer = (uint32_t *)kmalloc(w * h * 4);
    if (!fb.backbuffer)
        fb.backbuffer = fb.address;

    return 0;
}

void fb_swap(void)
{
    if (fb.backbuffer == fb.address) return;

    /* Copy backbuffer to VRAM using 64-bit transfers */
    uint64_t *src = (uint64_t *)fb.backbuffer;
    uint64_t *dst = (uint64_t *)fb.address;
    uint32_t total = fb.width * fb.height / 2;

    for (uint32_t i = 0; i < total; i++) {
        dst[i] = src[i];
    }
    if (fb.width * fb.height & 1) {
        uint32_t last = fb.width * fb.height - 1;
        fb.address[last] = fb.backbuffer[last];
    }
}

void fb_clear(uint32_t color)
{
    uint32_t total = fb.width * fb.height;
    for (uint32_t i = 0; i < total; i++) {
        fb.backbuffer[i] = color;
    }
}

void fb_putpixel(int x, int y, uint32_t color)
{
    if (x >= 0 && x < (int)fb.width && y >= 0 && y < (int)fb.height) {
        fb.backbuffer[y * fb.width + x] = color;
    }
}

uint32_t fb_getpixel(int x, int y)
{
    if (x >= 0 && x < (int)fb.width && y >= 0 && y < (int)fb.height) {
        return fb.backbuffer[y * fb.width + x];
    }
    return 0;
}


void fb_fill_rect(int x, int y, int w, int h, uint32_t color)
{
    for (int row = y; row < y + h; row++) {
        if (row < 0 || row >= (int)fb.height) continue;
        for (int col = x; col < x + w; col++) {
            if (col < 0 || col >= (int)fb.width) continue;
            fb.backbuffer[row * fb.width + col] = color;
        }
    }
}

void fb_draw_rect(int x, int y, int w, int h, uint32_t color)
{
    for (int i = x; i < x + w; i++) {
        fb_putpixel(i, y, color);
        fb_putpixel(i, y + h - 1, color);
    }
    for (int i = y; i < y + h; i++) {
        fb_putpixel(x, i, color);
        fb_putpixel(x + w - 1, i, color);
    }
}

void fb_draw_line(int x0, int y0, int x1, int y1, uint32_t color)
{
    int dx = x1 - x0, dy = y1 - y0;
    int sx = (dx > 0) ? 1 : -1;
    int sy = (dy > 0) ? 1 : -1;
    if (dx < 0) dx = -dx;
    if (dy < 0) dy = -dy;
    int err = dx - dy;

    while (1) {
        fb_putpixel(x0, y0, color);
        if (x0 == x1 && y0 == y1) break;
        int e2 = 2 * err;
        if (e2 > -dy) { err -= dy; x0 += sx; }
        if (e2 <  dx) { err += dx; y0 += sy; }
    }
}

void fb_draw_char(int x, int y, char c, uint32_t fg, uint32_t bg)
{
    if (c < 32 || c > 126) c = '?';
    const uint8_t *glyph = font_8x16[c - 32];
    for (int row = 0; row < 16; row++) {
        uint8_t bits = glyph[row];
        uint8_t bits_above = (row > 0)  ? glyph[row - 1] : 0;
        uint8_t bits_below = (row < 15) ? glyph[row + 1] : 0;
        for (int col = 0; col < 8; col++) {
            uint8_t mask = 0x80 >> col;
            if (bits & mask) {
                fb_putpixel(x + col, y + row, fg);
            } else {
                /* Anti-alias: check if adjacent pixels are filled */
                int neighbors = 0;
                if (bits_above & mask) neighbors++;
                if (bits_below & mask) neighbors++;
                if (col > 0 && (bits & (mask << 1))) neighbors++;
                if (col < 7 && (bits & (mask >> 1))) neighbors++;
                if (neighbors > 0) {
                    uint32_t base = (bg != 0) ? bg : fb_getpixel(x + col, y + row);
                    uint8_t alpha = (uint8_t)(neighbors * 40);
                    fb_putpixel(x + col, y + row, rgba_blend(base, fg, alpha));
                } else if (bg != 0) {
                    fb_putpixel(x + col, y + row, bg);
                }
            }
        }
    }
}

void fb_draw_string(int x, int y, const char *s, uint32_t fg, uint32_t bg)
{
    int cx = x;
    while (*s) {
        if (*s == '\n') {
            cx = x;
            y += 16;
        } else {
            fb_draw_char(cx, y, *s, fg, bg);
            cx += 8;
        }
        s++;
    }
}

void fb_blit(int dx, int dy, int w, int h, const uint32_t *src)
{
    for (int row = 0; row < h; row++) {
        for (int col = 0; col < w; col++) {
            fb_putpixel(dx + col, dy + row, src[row * w + col]);
        }
    }
}

framebuffer_t *fb_get(void)
{
    return &fb;
}
